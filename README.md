# Гипотеза

Цены на нефть зависят не только от спроса.

Например госдолг сша или новостной фон.

# Процесс выполнения

## Сравнение с госдолгом США

В файле main.ipynb было проведено сравнение госдолга США и цен на неть марки brent c 1993 по 2024 год. Была выявлена корреляция на уровне 0.57 что является средней связью. Это может означать что в какой-то степени решения властей США связаны с ценами на нефть в ту или иную сторону.

## Сравнение цен крупных продавцов нефти

Далее в файле main.ipynb было произведено сравнение цен всех крупных марок нефти на основе данных организации OPEC. Было выяснено что цены практически не различаются, из-за чего далее анализ производился по ценам марки brent из-за лёгкости в получении этих данных.

## Связь новостей и цен на нефть

### Парсер

Для начала в файле parser.py был запущен парсер новостей с сайта rbc.
За основу был взят существующий парсер с кегля [5].
Парсер был улучшен для сбора огромного количества данных. Стаднартная версия собиарала весь 2010 год за час. Улучшенная версия собирается за 15 минут все новости с 2010 по 2024 год.
За счёт чего ускорился код:
- асинхронноое выполнение сразу пачки запросов через asyncio.gather с использованием библиотеки aiohttp
- промежуточный результат сохранялся на случай падения парсера(что случалось очень часто)
- визуализация прогресса с использованием tqdm

Алгоритм парсера:
1. Подготавливаются сразу пачки ссылок для поиска
2. С каждой страницы поиска собираются ссылки на все новости(ссылки на них имеют в пути какой-то hash, поэтому пришлось получать на них ссылки через поиск).
3. Каждые 5 дней сохраняется промежуточный результат
4. После завершения парсера все промежуточные результаты копируются на уровень директории где лежал скрипт с названием дат начала и конца.

Так же стоит упомянуть, что подготовка ссылок для поиска происходит параллельно самому получения текста из новостей для ещё большего ускорения работы.

### Получение эмбедингов

Чтобы проводить какой-то числовой анализ текста нужно получить его эмбединги. Для этого была использована модель text-embedding-3-small от OpenAI доступная только по API. [6]

Выпонять получение эмбедингов для каждой новости отдельно было долго даже через много потоков. Поэтому все новости были конвертированы в jsonl [openai_utils.py] для запроса пачков(batch)[7]. Отправить в 1 batch можно максимум 50к запросов. Поэтому все новости были разбиты на пачки по 50к и отправлены на обработку. Всего было отправлено 5 пачки[j1.jsonl, j2.jsonl, j3.jsonl, j4.jsonl, j5.jsonl]. 4 полные и в одной 35к новостей. Процесс занял 5 часов суммарно. Обработка всех батчей произошла одновременно спустя 4 часа после отправки в API.

Далее были скачаны 5 файлов уже с эмбедингами [b1.jsonl, b1.jsonl, b1.jsonl, b1.jsonl, b1.jsonl]. Файл с запросами весит 27 мегабайт. Файлы с ответами весят суммарно 4.7 гигабайт.

Далее в файле main.ipynb все эмбединги были объединены в датасет.
Датасет был приведён к другому формату - id, time, text, embedings(это были мыссивы флотов по 1536 элементов каждый). И всё это было сохранено в файл batch.jsonl.

### Анализ связи новостей и цено на нефть на основе эмбедингов

Все дейтсвия данного параграфа происходят в notebook.ipynb.

Для анализа использовались цена на нефть брент с 1987 года по 2022.[2]

Т.к. за день новостей было много, было решенео ввести новый признак - новость дня(эмбединг дня).

В отдельный датасет были вставлены следующие значения - цена на нефть, эмбединг дня, дата.

Эмбединг дня был получен как среднее значение всех эмбедингов новостей за день.

Далее была проведена визуализация новостной повестки дня путём сжатия эмбедингов новостей в 2d с помощью PCA с 1536 размерностей до 2. PCA был выбран вместо tSNE(хоть OpenAI и используют в гайде tSNE) по причине высокой скорости и меньших затратах, однозначной работы на одних и тех же данных(нет рандома). Визуализация показала что новости действительно разделяются на кластеры.

Путём перебора значения количества кластеров было решено оставить 4, т.к. при больших значениях ему просто не хватало данных. А при меньших анализ не имеет смысла.

Далее была проивзедена визуализация разбораса цен на нефть в зависимости от от кластера. Как мы можем заметить по выводу ячейки 19, во бирюзовом класстере находится самый большой разброс цен на нефть. В то время как жёлтый класстер влиял меньше всего, несколько дней не касающихся основной части класстера больше похожи на выбросы. В то время как фиолетовый кластер имеет топ 2 влияние, но при этом имеет меньший разброс цен.

# Вывод

Новостной фон действительно имеет некоторое влияние на цены на нефть. Можно считать что существует какая-то категория новостей, которая влияет на цены на нефть. С использованными методами сложно понять что это за категория

# Предупреждение

Не пытайтесь запустить файл notebook.ipynb - требуется минмиуму 56 гигабайт оперативной памяти. Google Collab не хватит!
Для проверки можно использовать севрер селктел, 60гб и 2 ядра cpu хватает(стоит выбрать прерываемая ВМ т.к. она дешевле). На нём был запущен юпитер сервер и из vs code было проивзедено подключение к нему.
https://selectel.ru/prices/calculator/?product=cloudServers


# Источники

[1] Цены нефти общие
https://asb.opec.org/data/ASB_Data.php

[2] Цены на нефть brent с 1987 по 2022 год
https://www.kaggle.com/datasets/mabusalah/brent-oil-prices

[3] Госдолг сша
https://fiscaldata.treasury.gov/datasets/debt-to-the-penny/debt-to-the-penny

[4] Новости
https://www.rbc.ru/

[5] Парсер новостей с rbc
https://www.kaggle.com/code/hardtype/parsing-news-from-rbc-lenta-ru

[6] Модели эмбедингов OpenAI
https://platform.openai.com/docs/guides/embeddings

[7] Batch запросы к API OpenAI
https://platform.openai.com/docs/guides/batch/overview

[8] Новости, батчи для эмбедингови сами эмбединги
https://disk.yandex.ru/d/ozhwvdJY4sSWCg